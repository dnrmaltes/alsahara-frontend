<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B-10 Â· Estado de pedido Â· Al Sahara</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body{background:#f7f7f5}
    .card{border-radius:14px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
    .step{display:flex;align-items:center;gap:.5rem}
    .dot{width:.75rem;height:.75rem;border-radius:50%;background:#e5e7eb}
    .step.done .dot{background:#198754}
    .step.current .dot{background:#0d6efd}
    .muted{color:#6b7280}
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Al Sahara</a>
      <div class="d-flex gap-3">
        <a class="nav-link text-white-50" href="catalogo.html">CatÃ¡logo</a>
        <a class="nav-link text-white-50" href="orden_despacho.html">Orden de despacho</a>
      </div>
    </div>
  </nav>

  <main class="container py-4" style="max-width:840px">
    <h1 class="h4 mb-3">Estado de pedido</h1>

    <div id="msg" class="alert d-none"></div>

    <!-- Buscar tracking -->
    <form id="form-lookup" class="card shadow-sm mb-3">
      <div class="card-body">
        <label class="form-label" for="trk">Ingresa tu cÃ³digo de seguimiento</label>
        <div class="input-group">
          <input id="trk" class="form-control mono" placeholder="ALSA-CHX-000123" required />
          <button class="btn btn-primary">Consultar</button>
        </div>
        <div class="form-text">El cÃ³digo fue generado al crear la orden (US-09) y tambiÃ©n aparece en tu boleta.</div>
      </div>
    </form>

    <!-- Resultado -->
    <div id="result" class="card shadow-sm d-none">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <div class="small text-muted">Tracking</div>
            <div id="r-trk" class="mono">â€”</div>
          </div>
          <div class="text-end">
            <div class="small text-muted">Ãšltima actualizaciÃ³n</div>
            <div id="r-updated" class="mono">â€”</div>
          </div>
        </div>

        <hr>

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <div class="small text-muted">Estado actual</div>
            <div id="r-status" class="fw-semibold">â€”</div>
          </div>
          <div class="col-12 col-md-6 text-md-end">
            <div class="small text-muted">Resumen</div>
            <div id="r-summary" class="muted">â€”</div>
          </div>
        </div>

        <div class="vstack gap-2 my-3" id="steps">
          <div class="step" data-s="CREATED"><span class="dot"></span><span>Creada</span></div>
          <div class="step" data-s="WAREHOUSE"><span class="dot"></span><span>En bodega</span></div>
          <div class="step" data-s="ONROUTE"><span class="dot"></span><span>En ruta</span></div>
          <div class="step" data-s="DELIVERED"><span class="dot"></span><span>Entregada</span></div>
        </div>

        <div class="d-flex flex-wrap gap-2">
          <button id="btn-refresh" class="btn btn-outline-secondary">Actualizar estado</button>
          <a id="btn-print" href="#" class="btn btn-outline-dark">Imprimir comprobante</a>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      const msg = $("msg");
  
      // ðŸ‘‰ Endpoint real de la API (ajÃºstalo si usas otro)
      const API_TRACK = "http://localhost:3000/api/pedidos/";
  
      const STATES = ["CREATED","WAREHOUSE","ONROUTE","DELIVERED"];
      const STATUS_LABEL = {
        CREATED:   "Creada",
        WAREHOUSE: "En bodega",
        ONROUTE:   "En ruta",
        DELIVERED: "Entregada"
      };
      const STATUS_SUMMARY = {
        CREATED:   "Tu pedido fue recibido y estÃ¡ en procesamiento.",
        WAREHOUSE: "Tu pedido se estÃ¡ preparando en bodega.",
        ONROUTE:   "El pedido saliÃ³ a reparto con el courier.",
        DELIVERED: "Pedido entregado en destino."
      };
  
      // Helpers
      function showMsg(type, text){
        msg.className = "alert alert-" + type;
        msg.textContent = text;
        msg.classList.remove("d-none");
      }
      function hideMsg(){ msg.classList.add("d-none"); }
      function nowStr(){ return new Date().toLocaleString(); }
  
      // localStorage como respaldo (lo que ya usabas con US-09)
      function loadShipmentLS(){
        try { return JSON.parse(localStorage.getItem("alsahara.shipment") || "null"); }
        catch(_){ return null; }
      }
  
      function renderSteps(current){
        document.querySelectorAll(".step").forEach(el=>{
          const code = el.getAttribute("data-s");
          el.classList.toggle("done", STATES.indexOf(code) < STATES.indexOf(current));
          el.classList.toggle("current", code === current);
        });
      }
  
      function renderResult(s){
        $("r-trk").textContent = s.tracking;
        $("r-updated").textContent = s.updatedAt || nowStr();
  
        const statusCode = s.status || s.estado || "CREATED";
        $("r-status").textContent  = STATUS_LABEL[statusCode] || statusCode;
        $("r-summary").textContent = s.summary || s.resumen || STATUS_SUMMARY[statusCode] || "";
  
        renderSteps(statusCode);
        $("result").classList.remove("d-none");
      }
  
      // -------- CONSULTA PRINCIPAL: primero API, luego respaldo local --------
      async function lookup(tracking, {silent=false} = {}){
        hideMsg();
        $("result").classList.add("d-none");
  
        // 1) Intentar contra la API
        try {
          const res = await fetch(API_TRACK + encodeURIComponent(tracking));
          if (res.ok) {
            const data = await res.json();
            // Intentamos mapear campos tÃ­picos
            const pedido = {
              tracking: data.tracking || data.codigo || tracking,
              status:   data.status   || data.estado   || "CREATED",
              summary:  data.summary  || data.resumen  || ""
            };
            renderResult(pedido);
            if (!silent) showMsg("success", "Estado obtenido desde el servidor.");
            return;
          }
        } catch (err) {
          console.error("Error API pedidos:", err);
          if (!silent) showMsg("warning", "No se pudo contactar al servidor, intentando con datos localesâ€¦");
        }
  
        // 2) Respaldo: lo que dejÃ³ US-09 en localStorage
        const s = loadShipmentLS();
        if(!s || !s.tracking){
          showMsg("warning","No se encontrÃ³ ninguna orden en este navegador. Genera una en 'Orden de despacho'.");
          return;
        }
        if(s.tracking !== tracking){
          showMsg("info","El tracking ingresado no coincide con la Ãºltima orden creada aquÃ­. IngrÃ©salo tal cual aparece (ej. ALSA-CHX-000123).");
          return;
        }
        renderResult(s);
        if (!silent) showMsg("secondary","Mostrando estado desde datos locales.");
      }
  
      // Cargar tracking desde querystring si viene ?t=ALSA-...
      const qs = new URLSearchParams(location.search);
      const tFromQuery = qs.get("t");
      if(tFromQuery){ $("trk").value = tFromQuery; }
  
      // Al enviar el formulario
      $("form-lookup").addEventListener("submit",(e)=>{
        e.preventDefault();
        const tracking = $("trk").value.trim().toUpperCase();
        if(!tracking){
          showMsg("warning","Ingresa un cÃ³digo de seguimiento.");
          return;
        }
        lookup(tracking);
      });
  
      // BotÃ³n actualizar: vuelve a consultar (API + fallback)
      $("btn-refresh").addEventListener("click", ()=>{
        const tracking = $("trk").value.trim().toUpperCase();
        if(!tracking){
          showMsg("warning","Ingresa un cÃ³digo para actualizar.");
          return;
        }
        lookup(tracking, {silent:true}).then(()=>{
          showMsg("success","Estado actualizado.");
        });
      });
  
      // â€œImprimir comprobanteâ€ â†’ a boleta si existe, si no imprime esta pÃ¡gina
      $("btn-print").addEventListener("click",(e)=>{
        e.preventDefault();
        if(localStorage.getItem("alsahara.paymentId")){
          location.href = "boleta.html";
        }else{
          window.print();
        }
      });
  
      // Autolookup si viene por query
      if(tFromQuery){ lookup(tFromQuery.toUpperCase()); }
    })();
  </script>
</body>
</html>