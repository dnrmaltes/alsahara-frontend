<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B-03 · Recuperación de contraseña · Al Sahara</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Al Sahara</a>
    </div>
  </nav>

  <main class="container py-5" style="max-width:620px">
    <h1 class="h4 mb-3">Recuperar contraseña</h1>

    <!-- Mensajes -->
    <div id="rec-msg" class="alert d-none" role="alert"></div>

    <!-- FORM SOLICITUD DE TOKEN -->
    <form id="form-request" class="card p-4 shadow-sm bg-white mb-4" novalidate>
      <div class="mb-3">
        <label class="form-label" for="email">Email registrado</label>
        <input name="email" id="email" type="email" class="form-control" placeholder="ana@example.com" required />
      </div>
      <button class="btn btn-primary w-100">Solicitar enlace de recuperación</button>
    </form>

    <!-- FORM NUEVA CONTRASEÑA -->
    <form id="form-reset" class="card p-4 shadow-sm bg-white d-none" novalidate>
      <h2 class="h6 mb-3">Restablecer contraseña</h2>
      <div class="mb-3">
        <label class="form-label" for="token">Token</label>
        <input name="token" id="token" type="text" class="form-control" required />
        <div class="form-text">Código de 6 dígitos recibido por correo.</div>
      </div>
      <div class="mb-3">
        <label class="form-label" for="newpass">Nueva contraseña</label>
        <input
          name="newpass"
          id="newpass"
          type="password"
          class="form-control"
          required
          minlength="8"
          pattern="(?=.*[A-Z])(?=.*\\d).{8,}"
          placeholder="8+ caracteres, 1 mayúscula y 1 dígito"
        />
        <div class="form-text">Debe tener 8+ caracteres, al menos 1 mayúscula y 1 dígito.</div>
      </div>
      <button class="btn btn-success w-100">Guardar nueva contraseña</button>
    </form>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  (function () {
    const API_BASE    = "http://localhost:3000/api/auth";
    const API_RECOVER = API_BASE + "/recover";
    const API_RESET   = API_BASE + "/reset";

    const formReq   = document.getElementById("form-request");
    const formReset = document.getElementById("form-reset");
    const msg       = document.getElementById("rec-msg");

    function show(type, text) {
      msg.className = "alert alert-" + type;
      msg.textContent = text;
      msg.classList.remove("d-none");
    }

    function validEmail(v){ return /\S+@\S+\.\S+/.test(v); }
    function validStrongPass(v){
      return /^(?=.*[A-Z])(?=.*\d).{8,}$/.test(v);
    }

    // 1) Solicitar token
    formReq.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = formReq.email.value.trim();

      if (!validEmail(email)) {
        show("warning", "Email inválido.");
        return;
      }

      try {
        const res = await fetch(API_RECOVER, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email })
        });

        let data = {};
        try { data = await res.json(); } catch (_) {}

        console.log("DATA RECIBIDA RECOVER:", data);

        if (!res.ok) {
          show("danger", data.detail || data.message || "No se pudo solicitar la recuperación.");
          return;
        }

        const token = data.token;       
        console.log("TOKEN BACKEND:", token);

        localStorage.setItem("alsahara.recover.token", token);

        show("success", "Se envió un código de recuperación (simulado). Token: " + token);

        formReq.classList.add("d-none");
        formReset.classList.remove("d-none");

      } catch (err) {
        console.error("RECOVER ERROR", err);
        show("danger", "Error de conexión con el servidor.");
      }
    });

    // 2) Resetear contraseña
    formReset.addEventListener("submit", async (e) => {
      e.preventDefault();

      const token      = formReset.token.value.trim();
      const newPass    = formReset.newpass.value.trim();
      const savedToken = localStorage.getItem("alsahara.recover.token");

      console.log("TOKEN INPUT:", token);
      console.log("TOKEN GUARDADO:", savedToken);

      if (!savedToken) {
        show("danger", "Debes solicitar un token primero.");
        return;
      }

      if (token !== savedToken) {
        show("warning", "Token incorrecto.");
        return;
      }

      if (!validStrongPass(newPass)) {
        show("warning", "La contraseña debe tener 8+ caracteres, 1 mayúscula y 1 dígito.");
        return;
      }

      try {
        const res = await fetch(API_RESET, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, newPassword: newPass })
        });

        let data = {};
        try { data = await res.json(); } catch (_) {}

        console.log("RESET RESPUESTA:", data);

        if (!res.ok) {
          show("danger", data.detail || data.message || "Error al resetear contraseña.");
          return;
        }

        localStorage.removeItem("alsahara.recover.token");

        show("success", "Contraseña actualizada. Redirigiendo…");
        setTimeout(() => {
          window.location.href = "login.html";
        }, 1200);

      } catch (err) {
        console.error("RESET ERROR", err);
        show("danger", "Error de conexión con el servidor.");
      }
    });
  })();
  </script>
</body>
</html>