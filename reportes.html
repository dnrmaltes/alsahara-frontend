<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Reportes ¬∑ Al Sahara (B-12 & B-14)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#f7f7f5}
    .card{border-radius:14px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
    .kpi{border-radius:14px}
    @media print{ .no-print{display:none!important} body{background:#fff} .card{box-shadow:none;border:0} }
  </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-dark no-print">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">Al Sahara</a>
    <div class="d-flex gap-3">
      <a class="nav-link text-white-50" href="catalogo.html">Cat√°logo</a>
      <a class="nav-link text-white-50" href="admin_productos.html">Admin</a>
      <a class="nav-link text-white" href="reportes.html">Reportes</a>
    </div>
  </div>
</nav>

<main class="container py-4" style="max-width:1100px">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <h1 class="h4 m-0">Reportes de ventas</h1>
    <div class="no-print d-flex gap-2">
      <button id="btn-export" class="btn btn-outline-secondary">Exportar CSV</button>
      <button id="btn-print" class="btn btn-outline-dark">Imprimir</button>
      <button id="btn-seed" class="btn btn-primary">Simular venta ahora</button>
    </div>
  </div>

  <!-- Filtros (US-12) -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-sm-6 col-md-3">
          <label class="form-label">Fecha inicio</label>
          <input id="from" type="date" class="form-control"/>
        </div>
        <div class="col-sm-6 col-md-3">
          <label class="form-label">Fecha fin</label>
          <input id="to" type="date" class="form-control"/>
        </div>
        <div class="col-sm-12 col-md-6 d-flex gap-2">
          <button id="btn-apply" class="btn btn-primary flex-grow-1">Aplicar filtros</button>
          <button id="btn-clear" class="btn btn-outline-secondary">Limpiar</button>
        </div>
      </div>
      <div class="form-text mt-2">
        Si no aplicas filtros, se muestran los totales generales de todas las boletas almacenadas en la API.
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-sm-6 col-lg-3">
      <div class="kpi card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Total ventas</div>
          <div id="k-total" class="h4 mono m-0">$0</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="kpi card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">N¬∞ boletas</div>
          <div id="k-orders" class="h4 mono m-0">0</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="kpi card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Ticket promedio</div>
          <div id="k-avg" class="h4 mono m-0">$0</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="kpi card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">√öltima boleta</div>
          <div id="k-last" class="h6 mono m-0">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Totales por categor√≠a (todo en ‚ÄúGeneral‚Äù porque la API no trae categor√≠a) -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h2 class="h6 mb-3">Totales por categor√≠a</h2>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
          <tr><th>Categor√≠a</th><th class="text-end">Ventas</th><th class="text-end">Boletas</th></tr>
          </thead>
          <tbody id="tbody-cat"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tabla de boletas -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h2 class="h6 mb-3">Detalle de boletas</h2>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light">
          <tr>
            <th>Fecha</th>
            <th>Boleta ID</th>
            <th>Orden</th>
            <th class="text-end">Total</th>
          </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="empty" class="text-center text-muted py-4 d-none">
        No hay boletas en el rango seleccionado ni en la API.
      </div>
      <div id="msg" class="alert alert-danger mt-3 d-none"></div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  // üëá Ruta REAL de tu backend
  const API = "http://localhost:3000/api/reportes/ventas";

  const money   = n => "$" + Number(n||0).toLocaleString();
  const fmtDate = d => new Date(d).toLocaleString();

  // Boletas del backend
  let boletasAPI = [];
  // Boletas simuladas en front (para mostrar algo aunque el store.boletas est√© vac√≠o)
  let boletasSimuladas = [];

  function getBoletasCombinadas(){
    return [...boletasAPI, ...boletasSimuladas];
  }

  function showError(text){
    const msg = $("msg");
    msg.textContent = text;
    msg.classList.remove("d-none");
  }
  function hideError(){
    $("msg").classList.add("d-none");
  }

  // ---- Filtros por fecha
  function applyFilters(list){
    const fromValue = $("from").value;
    const toValue   = $("to").value;

    const f = fromValue ? new Date(fromValue) : null;
    const t = toValue   ? new Date(toValue + "T23:59:59") : null;

    return list.filter(b => {
      const d = new Date(b.fecha);
      if (f && d < f) return false;
      if (t && d > t) return false;
      return true;
    });
  }

  function render(){
    hideError();

    const all = getBoletasCombinadas();
    const filtered = applyFilters(all);

    // KPIs
    const total = filtered.reduce((s,b)=> s + (b.total || 0), 0);
    const n     = filtered.length;
    const avg   = n ? total / n : 0;
    const last  = filtered.slice().sort((a,b)=> new Date(b.fecha) - new Date(a.fecha))[0];

    $("k-total").textContent  = money(total);
    $("k-orders").textContent = String(n);
    $("k-avg").textContent    = money(avg);
    $("k-last").textContent   = last ? fmtDate(last.fecha) : "‚Äî";

    // ‚ÄúCategor√≠as‚Äù: todo metido en una categor√≠a general
    const tbodyCat = $("tbody-cat");
    if (filtered.length === 0) {
      tbodyCat.innerHTML = `<tr><td colspan="3" class="text-center text-muted">Sin datos</td></tr>`;
    } else {
      tbodyCat.innerHTML = `
        <tr>
          <td>General</td>
          <td class="text-end mono">${money(total)}</td>
          <td class="text-end mono">${n}</td>
        </tr>
      `;
    }

    // Tabla detalle boletas
    const tbody = $("tbody");
    if (filtered.length === 0) {
      tbody.innerHTML = "";
      $("empty").classList.remove("d-none");
    } else {
      $("empty").classList.add("d-none");
      tbody.innerHTML = filtered
        .slice()
        .sort((a,b)=> new Date(b.fecha) - new Date(a.fecha))
        .map(b => `
          <tr>
            <td class="mono">${fmtDate(b.fecha)}</td>
            <td class="mono">${b.id}</td>
            <td class="mono">${b.ordenId || "‚Äî"}</td>
            <td class="text-end mono">${money(b.total)}</td>
          </tr>
        `).join("");
    }
  }

  // ---- Cargar datos desde la API
  async function loadFromAPI(){
    hideError();
    try {
      const res = await fetch(API);
      if (!res.ok) {
        showError("Error al obtener reportes desde la API (HTTP " + res.status + ").");
        boletasAPI = [];
        render();
        return;
      }
      const data = await res.json();
      if (!data.ok) {
        showError("La API respondi√≥ con error: " + (data.error || "desconocido"));
        boletasAPI = [];
        render();
        return;
      }
      // data.detalle = store.boletas
      boletasAPI = Array.isArray(data.detalle) ? data.detalle : [];
      render();
    } catch (err) {
      console.error(err);
      showError("No se pudo conectar con /api/reportes/ventas. ¬øEl servidor est√° levantado?");
      boletasAPI = [];
      render();
    }
  }

  // ---- Export CSV (usa data combinada + filtros)
  function exportCSV(){
    const all       = getBoletasCombinadas();
    const filtered  = applyFilters(all);
    const header    = ["fecha","boletaId","ordenId","total"];
    const lines     = [header.join(",")].concat(filtered.map(b =>
      [
        new Date(b.fecha).toISOString(),
        b.id,
        b.ordenId || "",
        b.total || 0
      ].join(",")
    ));
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "reportes_alsahara.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ---- Simular venta (solo front, no toca el store del backend)
  function simulateSale(){
    const now = new Date();
    const fake = {
      id:      "SIM-" + Math.floor(Math.random()*900000 + 100000),
      ordenId: "ORD-" + Math.floor(Math.random()*900000 + 100000),
      total:   3000 * (2 + Math.floor(Math.random()*4)),
      fecha:   now.toISOString()
    };
    boletasSimuladas.push(fake);
    render();
  }

  // ---- Eventos UI
  $("btn-apply").addEventListener("click", render);
  $("btn-clear").addEventListener("click", ()=>{
    $("from").value = "";
    $("to").value   = "";
    render();
  });
  $("btn-export").addEventListener("click", exportCSV);
  $("btn-print").addEventListener("click", ()=>window.print());
  $("btn-seed").addEventListener("click", simulateSale);

  // Prefill: rango de este mes
  const now = new Date();
  const first = new Date(now.getFullYear(), now.getMonth(), 1);
  $("from").value = first.toISOString().slice(0,10);
  $("to").value   = now.toISOString().slice(0,10);

  // Cargar inicialmente desde la API
  loadFromAPI();
})();
</script>
</body>
</html>