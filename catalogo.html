<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B-04 · Catálogo · Al Sahara</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body{background:#f7f7f5}
    .badge-soft{background:#eef2ff;border:1px solid #c7d2fe;border-radius:12px;padding:.25rem .5rem;font-size:.75rem}
    .card{border-radius:14px}
  </style>
</head>
<body class="bg-light">
  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Al Sahara</a>
      <div class="d-flex gap-3">
        <a class="nav-link text-white-50" href="login.html">Iniciar sesión</a>
        <a class="nav-link text-white-50" href="registro.html">Registrarse</a>
      </div>
    </div>
  </nav>

  <header class="bg-white border-bottom">
    <div class="container py-3 d-flex flex-column flex-md-row align-items-md-center gap-3">
      <h1 class="h4 m-0 flex-grow-1">Catálogo</h1>
      <div class="input-group" style="max-width:420px">
        <span class="input-group-text">Buscar</span>
        <input id="search" class="form-control" placeholder="falafel, hummus…" />
      </div>
      <div class="btn-group" role="group" aria-label="Filtros">
        <button type="button" class="btn btn-outline-secondary" data-filter="">Todo</button>
        <button type="button" class="btn btn-outline-secondary" data-filter="Entradas">Entradas</button>
        <button type="button" class="btn btn-outline-secondary" data-filter="Platos">Platos</button>
        <button type="button" class="btn btn-outline-secondary" data-filter="Postres">Postres</button>
      </div>
    </div>
  </header>

  <main class="container py-4">
    <div id="emptyState" class="alert alert-info d-none">No hay productos que coincidan con tu búsqueda.</div>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3" id="grid"></div>
    <div class="d-flex justify-content-center py-4" id="pagination"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


  <script>
    (function () {
      const API_URL = "http://localhost:3000/api/catalogo/search";
    
      const state = {
        page: 1,
        perPage: 12,
        q: "",
        category: ""
      };
    
      function readQuery() {
        const p = new URLSearchParams(location.search);
        state.q        = p.get("q")   || "";
        state.category = p.get("cat") || "";
        state.page     = Math.max(1, parseInt(p.get("page") || "1", 10));
      }
    
      function writeQuery() {
        const p = new URLSearchParams();
        if (state.q)        p.set("q", state.q);
        if (state.category) p.set("cat", state.category);
        if (state.page > 1) p.set("page", String(state.page));
        const qs  = p.toString();
        const url = qs ? `?${qs}` : location.pathname;
        history.replaceState(null, "", url);
      }
    
      // ---- Render helpers ----
      function renderGrid(items) {
        const grid = document.getElementById("grid");
        if (!items || !items.length) {
          grid.innerHTML = "";
          document.getElementById("emptyState").classList.remove("d-none");
          return;
        }
        document.getElementById("emptyState").classList.add("d-none");
    
        grid.innerHTML = items.map(p => {

          const name  = p.nombre  || p.name  || "Producto";
          const price = p.precio  || p.price || 0;
          const cat   = p.categoria || p.category || "";
          const img   = p.imagen || p.img || "https://via.placeholder.com/400x260?text=Al+Sahara";
          return `
            <div class="col">
              <div class="card shadow-sm h-100">
                <img class="card-img-top" src="${img}" alt="${name}">
                <div class="card-body">
                  <h6 class="card-title mb-1">${name}</h6>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="badge-soft">${cat}</span>
                    <strong>$${Number(price).toLocaleString("es-CL")}</strong>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join("");
      }
    
      function renderPagination(meta) {
        const wrap = document.getElementById("pagination");
        const total    = meta?.total || 0;
        const perPage  = meta?.perPage || state.perPage;
        const current  = meta?.page || state.page;
        const pages    = Math.max(1, Math.ceil(total / perPage) || 1);
    
        state.page = current > pages ? pages : current;
    
        let html = `<nav aria-label="Paginación"><ul class="pagination mb-0">`;
        for (let i = 1; i <= pages; i++) {
          html += `
            <li class="page-item ${i === state.page ? "active" : ""}">
              <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>`;
        }
        html += `</ul></nav>`;
        wrap.innerHTML = html;
    
        wrap.querySelectorAll("a[data-page]").forEach(a => {
          a.addEventListener("click", (e) => {
            e.preventDefault();
            state.page = Number(a.dataset.page);
            writeQuery();
            loadProducts();
          });
        });
      }
    
      // ---- Llamada a la API ----
      async function loadProducts() {
        const grid  = document.getElementById("grid");
        const empty = document.getElementById("emptyState");
        const pagination = document.getElementById("pagination");
    
        grid.innerHTML = `<div class="col"><div class="text-center py-5 text-muted">Cargando catálogo…</div></div>`;
        empty.classList.add("d-none");
        pagination.innerHTML = "";
    
        const params = new URLSearchParams({
          q: state.q,
          categoria: state.category || "",   // ← el backend probablemente usa "categoria"
          page: String(state.page),
          perPage: String(state.perPage)
        });
    
        try {
          const res  = await fetch(`${API_URL}?${params.toString()}`);
          const data = await res.json();
    
        
          let items = [];
          let meta  = { total: 0, page: state.page, perPage: state.perPage };
    
          if (Array.isArray(data)) {
            items = data;
            meta.total = data.length;
          } else {
            items = data.items || [];
            meta.total   = data.total   ?? items.length;
            meta.page    = data.page    ?? state.page;
            meta.perPage = data.perPage ?? state.perPage;
          }
    
          renderGrid(items);
          renderPagination(meta);
    
          if (!items.length) {
            empty.classList.remove("d-none");
          }
    
        } catch (err) {
          console.error(err);
          grid.innerHTML = "";
          empty.classList.remove("d-none");
          empty.textContent = "Error al cargar el catálogo. Verifica que la API esté levantada.";
        }
      }
    
      // ---- Wiring de búsqueda y filtros ----
      function wire() {
        const input = document.getElementById("search");
        input.value = state.q;
        input.addEventListener("input", (e) => {
          state.q = e.target.value;
          state.page = 1;
          writeQuery();
          loadProducts();
        });
    
        document.querySelectorAll("[data-filter]").forEach(btn => {
          if (btn.dataset.filter === state.category) {
            btn.classList.add("btn-primary");
          }
          btn.addEventListener("click", () => {
            document.querySelectorAll("[data-filter]").forEach(b => b.classList.remove("btn-primary"));
            btn.classList.add("btn-primary");
            state.category = btn.dataset.filter;
            state.page = 1;
            writeQuery();
            loadProducts();
          });
        });
      }
    
      // ---- Init ----
      readQuery();
      wire();
      loadProducts();
    
    })();
    </script>
</body>
</html>