<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>B-11 · Admin · Productos · Al Sahara</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body{background:#f7f7f5}
    .card{border-radius:14px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono","Courier New",monospace}
    .chip{border-radius:999px;padding:.2rem .6rem;font-size:.75rem}
    .chip.ok{background:#e7f8ee;color:#157347;border:1px solid #daf2e3}
    .chip.off{background:#f8e7e7;color:#b02a37;border:1px solid #f1d4d6}
    .empty{border:1px dashed #cbd5e1;border-radius:12px;background:#fff}
    .thumb{width:56px;height:56px;object-fit:cover;border-radius:10px;background:#eee}
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">Al Sahara</a>
    <div class="d-flex gap-3">
      <a class="nav-link text-white-50" href="catalogo.html">Catálogo</a>
      <a class="nav-link text-white" href="admin_productos.html">Productos</a>
      <a class="nav-link text-white-50" href="admin_clientes.html">Clientes</a>
      <a class="nav-link text-white-50" href="reportes.html">Reportes</a>
    </div>
  </div>
</nav>

<main class="container py-4">
  <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
    <h1 class="h4 m-0 flex-grow-1">Administración · Productos</h1>
    <button id="btn-new" class="btn btn-primary">Nuevo producto</button>
  </div>

  <div id="msg" class="alert d-none"></div>

  <!-- Tabla -->
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Producto</th>
            <th>Categoría</th>
            <th>Precio</th>
            <th>Stock</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div id="empty" class="empty p-4 text-center d-none">
      No hay productos disponibles.
    </div>
  </div>
</main>

<!-- Modal Crear/Editar -->
<div class="modal fade" id="modalForm" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="form" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Nuevo producto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">

        <input type="hidden" name="id"/>

        <div class="mb-3">
          <label class="form-label">Nombre</label>
          <input name="name" class="form-control" placeholder="Shawarma" required>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Categoría</label>
            <select name="category" class="form-select" required>
              <option>Platos</option>
              <option>Entradas</option>
              <option>Postres</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Precio</label>
            <input name="price" type="number" min="0" class="form-control" placeholder="4500" required>
          </div>
        </div>

        <div class="row g-3 mt-0">
          <div class="col-md-6">
            <label class="form-label">URL Imagen</label>
            <input name="img" class="form-control" placeholder="https://…">
          </div>
          <div class="col-md-6">
            <label class="form-label">Disponibilidad</label>
            <select name="available" class="form-select">
              <option value="true">Disponible</option>
              <option value="false">Agotado</option>
            </select>
          </div>
        </div>

        <div class="mt-3">
          <label class="form-label">Descripción</label>
          <textarea name="desc" class="form-control" rows="2"></textarea>
        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal eliminar -->
<div class="modal fade" id="modalDelete" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        ¿Eliminar el producto <b id="delName">—</b>?
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="btn-confirm-del" class="btn btn-danger">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  (() => {
  
    const API_BASE = "http://localhost:3000/api/catalogo";
    const $ = id => document.getElementById(id);
    const msg = $("msg");
  
    const modalFormEl   = document.getElementById("modalForm");
    const modalDeleteEl = document.getElementById("modalDelete");
    const form          = document.getElementById("form");
    const btnNew        = document.getElementById("btn-new");
    const delNameEl     = $("delName");
    const btnConfirmDel = $("btn-confirm-del");
  
    const modalForm   = new bootstrap.Modal(modalFormEl);
    const modalDelete = new bootstrap.Modal(modalDeleteEl);
  
    let productos = [];
    let deleteId = null;
  
    function showMsg(type, text){
      msg.className = "alert alert-" + type;
      msg.textContent = text;
      msg.classList.remove("d-none");
      setTimeout(()=> msg.classList.add("d-none"), 2000);
    }
  
    async function loadProducts(){
      try{
        const res = await fetch(API_BASE);
        if(!res.ok) throw new Error("HTTP " + res.status);
        productos = await res.json();
        render();
      }catch(err){
        showMsg("danger","Error cargando productos");
        productos = [];
        render();
      }
    }
  
    function render(){
      const tb = $("tbody");
      if(!productos.length){
        tb.innerHTML = "";
        $("empty").classList.remove("d-none");
        return;
      }
      $("empty").classList.add("d-none");
  
      tb.innerHTML = productos.map(p=>`
        <tr>
          <td>
            <div class="d-flex align-items-center gap-3">
              <img class="thumb" src="${p.img || 'https://dummyimage.com/96x96/ddd/aaa.jpg&text=img'}">
              <div>
                <div class="fw-semibold">${p.name}</div>
                <div class="text-muted small">${p.desc || ""}</div>
              </div>
            </div>
          </td>
          <td>${p.category}</td>
          <td class="mono">$${Number(p.price).toLocaleString()}</td>
          <td><span class="chip ${p.available?'ok':'off'}">${p.available?'Disponible':'Agotado'}</span></td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary" data-edit="${p.id}">Editar</button>
            <button class="btn btn-sm btn-outline-warning" data-toggle="${p.id}">
              ${p.available ? 'Marcar agotado' : 'Marcar disponible'}
            </button>
            <button class="btn btn-sm btn-outline-danger" data-del="${p.id}">Eliminar</button>
          </td>
        </tr>
      `).join("");
  
      // eventos
      tb.querySelectorAll("[data-edit]").forEach(b=>
        b.addEventListener("click", ()=> openEdit(Number(b.dataset.edit)))
      );
      tb.querySelectorAll("[data-toggle]").forEach(b=>
        b.addEventListener("click", ()=> toggleAvailable(Number(b.dataset.toggle)))
      );
      tb.querySelectorAll("[data-del]").forEach(b=>
        b.addEventListener("click", ()=> askDelete(Number(b.dataset.del)))
      );
    }
  
    btnNew.addEventListener("click", ()=>{
      form.reset();
      form.id.value = "";
      document.getElementById("modalTitle").textContent = "Nuevo producto";
      modalForm.show();
    });
  
    // EDITAR
    function openEdit(id){
      const p = productos.find(x => x.id === id);
      if(!p) return;
  
      form.id.value = p.id;
      form.name.value = p.name;
      form.category.value = p.category;
      form.price.value = p.price;
      form.img.value = p.img || "";
      form.desc.value = p.desc || "";
      form.available.value = p.available ? "true" : "false";
  
      document.getElementById("modalTitle").textContent = "Editar producto";
      modalForm.show();
    }
  
    // GUARDAR
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
  
      const fd = new FormData(form);
      const id = fd.get("id");
      const body = {
        name: fd.get("name"),
        category: fd.get("category"),
        price: Number(fd.get("price")),
        img: fd.get("img"),
        desc: fd.get("desc"),
        available: fd.get("available") === "true"
      };
  
      try{
        let res;
        if (id){
          res = await fetch(`${API_BASE}/${id}`,{
            method:"PUT",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify(body)
          });
        } else {
          res = await fetch(API_BASE,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify(body)
          });
        }
  
        if(!res.ok) throw new Error("Error guardando producto");
        showMsg("success","Producto guardado");
        modalForm.hide();
        loadProducts();
  
      }catch(err){
        showMsg("danger",err.message);
      }
    });
  
    // TOGGLE DISPONIBLE
    async function toggleAvailable(id){
      try{
        const res = await fetch(`${API_BASE}/${id}/toggle`,{method:"PATCH"});
        if(!res.ok) throw new Error("Error cambiando disponibilidad");
        loadProducts();
      }catch(err){
        showMsg("danger",err.message);
      }
    }
  
    // ELIMINAR
    function askDelete(id){
      const p = productos.find(x => x.id === id);
      delNameEl.textContent = p?.name || "—";
      deleteId = id;
      modalDelete.show();
    }
  
    btnConfirmDel.addEventListener("click", async ()=>{
      try{
        const res = await fetch(`${API_BASE}/${deleteId}`,{method:"DELETE"});
        if(!res.ok) throw new Error("Error eliminando producto");
        showMsg("success","Producto eliminado");
        modalDelete.hide();
        loadProducts();
      }catch(err){
        showMsg("danger",err.message);
      }
    });
  
    // INIT
    loadProducts();
  
  })();
  </script>
</body>
</html>