<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B-02 · Inicio de sesión · Al Sahara</title>
  <!-- Bootstrap (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <!-- Navbar simple -->
  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Al Sahara</a>
    </div>
  </nav>

  <main class="container py-5" style="max-width:560px">
    <h1 class="h4 mb-3">Iniciar sesión</h1>

    <!-- Mensajes -->
    <div id="login-msg" class="alert d-none" role="alert"></div>

    <!-- FORM LOGIN -->
    <form id="form-login" class="card p-4 shadow-sm bg-white">
      <div class="mb-3">
        <label class="form-label" for="email">Email</label>
        <input name="email" id="email" type="email" class="form-control" placeholder="ana@example.com" required />
      </div>
      <div class="mb-3">
        <label class="form-label" for="password">Contraseña</label>
        <input name="password" id="password" type="password" class="form-control" required minlength="6" />
        <div class="form-text">Mínimo 6 caracteres.</div>
      </div>
      <button class="btn btn-primary w-100">Entrar</button>
      <div class="text-center mt-3">
        <a href="recuperar.html" class="small">¿Olvidaste tu contraseña?</a>
      </div>
    </form>
  </main>

  <!-- Bootstrap JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


  <script>
    (function () {
      
      const API_LOGIN = "http://127.0.0.1:3000/api/auth/login";

      const form = document.getElementById("form-login");
      const msg  = document.getElementById("login-msg");

      // ---------- Configuraciones ----------
      const MAX_ATTEMPTS = 5;              // intentos antes de bloquear
      const LOCK_MS      = 2 * 60 * 1000;  // 2 minutos de bloqueo
      const SESSION_MIN  = 20;             // sesión expira en 20 minutos
      const LS_KEYS = {
        attempts: "alsahara.login.attempts",
        lock:     "alsahara.login.lockUntil",
        session:  "alsahara.session",      // { email, token, expiresAt }
      };

      // ---------- Utils ----------
      function show(type, text) {
        msg.className = "alert alert-" + type;
        msg.textContent = text;
        msg.classList.remove("d-none");
      }
      function hideMsg() { msg.classList.add("d-none"); }
      function now() { return Date.now(); }

      function getAttempts() {
        return parseInt(localStorage.getItem(LS_KEYS.attempts) || "0", 10);
      }
      function setAttempts(n) {
        localStorage.setItem(LS_KEYS.attempts, String(n));
      }
      function resetAttempts() { setAttempts(0); }

      function getLockUntil() {
        const v = localStorage.getItem(LS_KEYS.lock);
        return v ? parseInt(v, 10) : 0;
      }
      function setLockUntil(ts) { localStorage.setItem(LS_KEYS.lock, String(ts)); }
      function clearLock() { localStorage.removeItem(LS_KEYS.lock); }

      function isLocked() {
        const until = getLockUntil();
        return until && now() < until;
      }
      function lockRemainingSeconds() {
        const until = getLockUntil();
        return Math.max(0, Math.ceil((until - now()) / 1000));
      }

      function startSession(email, token) {
        const expiresAt = now() + SESSION_MIN * 60 * 1000;
        const session = { email, token: token || null, expiresAt };
        localStorage.setItem(LS_KEYS.session, JSON.stringify(session));
      }

      // ---------- Check inicial de bloqueo ----------
      function checkLockAndInform() {
        if (isLocked()) {
          const secs = lockRemainingSeconds();
          show("danger", "Cuenta temporalmente bloqueada. Intenta nuevamente en " + secs + "s.");
          return true;
        }
        
        if (getLockUntil() && !isLocked()) {
          clearLock();
          resetAttempts();
        }
        return false;
      }

      checkLockAndInform();

      // ---------- Validaciones simples ----------
      function validEmail(v) { return /\S+@\S+\.\S+/.test(v); }
      function validPass(v)  { return v && v.length >= 6; }

      // ---------- Manejo de submit (ASYNC contra FastAPI) ----------
      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        hideMsg();

        // Si está bloqueado, no procesar
        if (checkLockAndInform()) return;

        const email = form.email.value.trim();
        const pass  = form.password.value.trim();

        if (!validEmail(email)) {
          show("warning", "Email inválido.");
          return;
        }
        if (!validPass(pass)) {
          show("warning", "La contraseña debe tener al menos 6 caracteres.");
          return;
        }

        try {
          const res = await fetch(API_LOGIN, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: email,
              password: pass  
            })
          });

          let data = {};
          try { data = await res.json(); } catch (_) {}

          if (!res.ok) {
            // fallo de autenticación → sumar intento y bloquear si corresponde
            const current = getAttempts() + 1;
            setAttempts(current);

            const mensaje = data.message || "Credenciales inválidas.";
            if (current >= MAX_ATTEMPTS) {
              setLockUntil(now() + LOCK_MS);
              show("danger", mensaje + " Has superado los " + MAX_ATTEMPTS + " intentos. Cuenta bloqueada por 2 minutos.");
            } else {
              const restantes = MAX_ATTEMPTS - current;
              show("warning", mensaje + " Te quedan " + restantes + " intento(s) antes del bloqueo.");
            }
            return;
          }

          // Éxito → limpiar contadores y bloqueo
          resetAttempts();
          clearLock();

          // Guardar sesión (email + token si lo devuelve la API)
          startSession(email, data.token);

          show("success", "Inicio de sesión exitoso. Redirigiendo…");
          setTimeout(function () {
            window.location.href = "catalogo.html"; // o index.html si prefieres
          }, 900);

        } catch (err) {
          console.error(err);
          show("danger", "Error al conectar con el servidor. Inténtalo nuevamente.");
        }
      });

      // ---------- Timer visual si está bloqueado ----------
      if (isLocked()) {
        const timer = setInterval(() => {
          if (!isLocked()) {
            clearInterval(timer);
            hideMsg();
            show("info", "Bloqueo finalizado. Puedes intentar nuevamente.");
          } else {
            const secs = lockRemainingSeconds();
            show("danger", "Cuenta temporalmente bloqueada. Intenta nuevamente en " + secs + "s.");
          }
        }, 1000);
      }
    })();
  </script>
</body>
</html>