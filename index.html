<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Al Sahara · Catálogo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body{background:#f7f7f5}
    .badge-soft{background:#eef2ff;border:1px solid #c7d2fe;border-radius:12px;padding:.25rem .5rem;font-size:.75rem}
    .card{border-radius:14px}
  </style>
</head>
<body class="bg-light">
  
  <nav class="navbar navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Al Sahara</a>
      <div class="d-flex gap-3">
        <a class="nav-link text-white-50" href="login.html">Iniciar sesión</a>
        <a class="nav-link text-white-50" href="registro.html">Registrarse</a>
      </div>
    </div>
  </nav>

  <header class="bg-white border-bottom">
    <div class="container py-3 d-flex flex-column flex-md-row align-items-md-center gap-3">
      <h1 class="h4 m-0 flex-grow-1">Catálogo</h1>
      <div class="input-group" style="max-width:420px">
        <span class="input-group-text">Buscar</span>
        <input id="search" class="form-control" placeholder="falafel, hummus…" />
      </div>
      <div class="btn-group" role="group" aria-label="Filtros">
        <button type="button" class="btn btn-outline-secondary" data-filter="">Todo</button>
        <button type="button" class="btn btn-outline-secondary" data-filter="Entradas">Entradas</button>
        <button type="button" class="btn btn-outline-secondary" data-filter="Platos">Platos</button>
        <button type="button" class="btn btn-outline-secondary" data-filter="Postres">Postres</button>
      </div>
    </div>
  </header>

  <main class="container py-4">
    <div id="msg" class="alert d-none" role="alert"></div>
    <div id="emptyState" class="alert alert-info d-none">No hay productos que coincidan con tu búsqueda.</div>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3" id="grid"></div>
    <div class="d-flex justify-content-center py-4" id="pagination"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- LÓGICA: listado desde API, búsqueda, filtros, paginación y persistencia -->
  <script>
    (function () {
      const API_SEARCH = "http://localhost:3000/api/catalogo/search";

      const state = {
        page: 1,
        perPage: 12,
        q: "",
        category: ""
      };

      const msgEl   = document.getElementById("msg");
      const gridEl  = document.getElementById("grid");
      const emptyEl = document.getElementById("emptyState");
      const pagEl   = document.getElementById("pagination");
      const searchInput = document.getElementById("search");

      function showMsg(type, text){
        msgEl.className = "alert alert-" + type;
        msgEl.textContent = text;
        msgEl.classList.remove("d-none");
      }
      function hideMsg(){
        msgEl.classList.add("d-none");
      }

      // -------- Querystring ↔ estado --------
      function readQuery() {
        const p = new URLSearchParams(location.search);
        state.q = p.get("q") || "";
        state.category = p.get("cat") || "";
        state.page = Math.max(1, parseInt(p.get("page") || "1", 10));
      }

      function writeQuery() {
        const p = new URLSearchParams();
        if (state.q) p.set("q", state.q);
        if (state.category) p.set("cat", state.category);
        if (state.page>1) p.set("page", String(state.page));
        const qs = p.toString();
        const url = qs ? `?${qs}` : location.pathname;
        history.replaceState(null, "", url);
      }

      // -------- Render helpers --------
      function renderGrid(items){
        if (!Array.isArray(items)) items = [];
        if (items.length === 0) {
          gridEl.innerHTML = "";
          emptyEl.classList.remove("d-none");
          return;
        }
        emptyEl.classList.add("d-none");

        gridEl.innerHTML = items.map(p => {
          // Adaptar nombres que pueda devolver la API
          const name  = p.nombre   || p.name     || "Producto";
          const price = p.precio   || p.price    || 0;
          const cat   = p.categoria|| p.category || "";
          const img   = p.imagen   || p.img      || "https://via.placeholder.com/400x260?text=Al+Sahara";

          return `
          <div class="col">
            <div class="card shadow-sm h-100">
              <img class="card-img-top" src="${img}" alt="${name}">
              <div class="card-body">
                <h6 class="card-title mb-1">${name}</h6>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="badge-soft">${cat}</span>
                  <strong>$${Number(price || 0).toLocaleString("es-CL")}</strong>
                </div>
              </div>
            </div>
          </div>
          `;
        }).join("");
      }

      function renderPagination(total){
        const pages = Math.ceil((total || 0)/state.perPage) || 1;
        if (state.page > pages) state.page = pages;

        let html = `<nav aria-label="Paginación"><ul class="pagination mb-0">`;
        for(let i=1;i<=pages;i++){
          html += `<li class="page-item ${i===state.page?'active':''}">
            <a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
        }
        html += `</ul></nav>`;
        pagEl.innerHTML = html;

        pagEl.querySelectorAll("a[data-page]").forEach(a=>{
          a.addEventListener("click",(e)=>{
            e.preventDefault();
            state.page = Number(a.dataset.page);
            writeQuery();
            loadAndRender();  // recarga desde la API
          });
        });
      }

      // -------- Llamado a la API --------
      async function loadAndRender() {
        hideMsg();
        gridEl.innerHTML = `<div class="col-12 text-center text-muted py-5">Cargando catálogo…</div>`;

        const params = new URLSearchParams({
          q: state.q || "",
          categoria: state.category || "",
          page: String(state.page),
          perPage: String(state.perPage)
        });

        try {
          const res = await fetch(API_SEARCH + "?" + params.toString());
          if (!res.ok) {
            throw new Error("HTTP " + res.status);
          }
          const data = await res.json();

          // soporta: { items:[...], total } o simplemente [...]
          let items, total;
          if (Array.isArray(data)) {
            items = data;
            total = data.length;
          } else {
            items = data.items || data.productos || [];
            total = Number(data.total || items.length || 0);
          }

          renderGrid(items);
          renderPagination(total);
        } catch (err) {
          console.error(err);
          gridEl.innerHTML = "";
          emptyEl.classList.add("d-none");
          showMsg("danger", "No se pudo cargar el catálogo desde la API. Revisa que el servidor esté corriendo.");
        }
      }

      // -------- Wiring eventos --------
      function wire(){
        // input buscar
        searchInput.value = state.q;
        searchInput.addEventListener("input", (e)=>{
          state.q = e.target.value;
          state.page = 1;
          writeQuery();
          loadAndRender();
        });

        // botones de categoría
        document.querySelectorAll("[data-filter]").forEach(btn=>{
          if(btn.dataset.filter === state.category){
            btn.classList.add("btn-primary");
          }
          btn.addEventListener("click", ()=>{
            document.querySelectorAll("[data-filter]").forEach(b=>{
              b.classList.remove("btn-primary");
              b.classList.add("btn-outline-secondary");
            });
            btn.classList.remove("btn-outline-secondary");
            btn.classList.add("btn-primary");

            state.category = btn.dataset.filter;
            state.page = 1;
            writeQuery();
            loadAndRender();
          });
        });
      }

      // -------- Init --------
      readQuery();
      wire();
      loadAndRender();
    })();
  </script>
</body>
</html>